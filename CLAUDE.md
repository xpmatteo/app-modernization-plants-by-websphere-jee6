# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Plants By WebSphere is a legacy Java EE 6 eCommerce application modernized for cloud deployment. This is a modified version of the IBM WebSphere sample app, updated based on IBM Cloud Transformation Advisor recommendations for migration to WebSphere Liberty and containerized environments (OpenShift, IBM Cloud Private, IBM Cloud Kubernetes Service).

The application is a fictional online plant store that supports user registration and product purchases, backed by a relational database (MySQL/MariaDB).

## Architecture

### Multi-Module Maven Structure

The project uses a parent POM with three modules:

- **pbw-lib**: Shared utility JAR library (`com.ibm.websphere.samples.pbw.utils`)
- **pbw-web**: Web application WAR containing JPA entities, servlets, and JSF pages
- **pbw-ear**: Java EE 6 EAR assembly that packages pbw-lib and pbw-web together

Build order matters: pbw-lib → pbw-web → pbw-ear

### Runtime Architecture

- **Application Server**: WebSphere Liberty (based on Open Liberty) running Java EE 6 features
- **Database**: MariaDB or MySQL accessed via JDBC with JPA 2.1 for ORM
- **Configuration**: Liberty server.xml in `wlp/config/` defines features, datasources, and JNDI resources
- **Database Connection**: Uses environment variables (DB_HOST, DB_PORT, DB_USER, DB_PASSWORD) injected via Kubernetes secrets

### Key Java Packages

- `com.ibm.websphere.samples.pbw.jpa.*`: JPA entities (Customer, Order, Inventory, etc.) in pbw-web
- `com.ibm.websphere.samples.pbw.war.*`: Servlet beans (ProductBean, AccountBean, etc.) in pbw-web
- `com.ibm.websphere.samples.pbw.utils.*`: Utility classes in pbw-lib
- `pagecode.*`: JSF page backing beans in pbw-web

### Container & Deployment

- **Docker**: Base image `websphere-liberty:kernel` with MySQL JDBC driver
- **Liberty Config**: Generated by IBM Transformation Advisor, defines JTA/non-JTA datasources
- **Final Artifact**: `plants-by-websphere-jee6-mysql.ear` deployed to Liberty's apps directory

## Common Development Commands

### Running Locally with Docker Compose (Recommended for Development)

```bash
# Build the application
mvn clean package

# Start all services (MariaDB + Liberty)
docker-compose up -d

# View logs
docker-compose logs -f liberty

# Stop all services
docker-compose down

# Stop and remove volumes (clean database)
docker-compose down -v
```

**Application will be available at:**
- http://localhost:9080/ (main application)
- http://localhost:9443/ (HTTPS)

**Database credentials (configured in docker-compose.yml):**
- Host: localhost:3306
- Database: plantsdb
- User: dbuser
- Password: dbpass

### Building the Application

```bash
# Build all modules (lib, web, ear) from root
mvn clean package

# The final EAR artifact is copied to: target/plants-by-websphere-jee6-mysql.ear
```

### Building the Docker Image

```bash
# Build requires the EAR in target/ directory
docker build -t pbw-mariadb-web:1.0.0 .
```

### Running Tests

```bash
# Run tests for specific module
mvn test -pl pbw-lib
mvn test -pl pbw-web

# Run all tests
mvn test
```

### Deployment Scripts (For Kubernetes/OpenShift)

```bash
# Create Kubernetes secrets for database credentials
./scripts/create-secrets.sh

# Generate Kubernetes deployment manifests (interactive, prompts for namespace)
./scripts/create-deployment.sh

# Test database connection using secrets file
./scripts/test-db-connection.sh <db-validation-service-url>
```

## Deployment Targets

This app supports multiple deployment scenarios:

- **OpenShift**: Templates in `openshift/templates/` for S2I, Docker, and CI/CD workflows
- **IBM Cloud Private/Kubernetes**: Manifests in `k8s/` and Jenkinsfiles for automated pipelines
- **Helm Charts**: Chart in `chart/pbw-liberty-mariadb/` for Kubernetes deployment

## Critical Configuration Files

- `wlp/config/server.xml`: Liberty feature manager, datasource definitions (MySQL/MariaDB), JNDI names
- `pbw-web/src/main/resources/META-INF/persistence.xml`: JPA persistence unit configuration
- `pbw-web/src/main/webapp/WEB-INF/web.xml`: Web app deployment descriptor
- `Dockerfile`: Multi-stage build copying MySQL driver and server.xml into Liberty image

## Environment Variables

The application expects these environment variables (typically from Kubernetes secrets):

- `DB_HOST`: Database server hostname
- `DB_PORT`: Database port (typically 3306)
- `DB_USER`: Database username
- `DB_PASSWORD`: Database password

Database name is hardcoded to `plantsdb` in server.xml.

## CI/CD Pipelines

Multiple Jenkinsfiles support different environments:

- `Jenkinsfile`: Base Kubernetes pipeline
- `Jenkinsfile.ocp`: OpenShift-specific pipeline
- `Jenkinsfile.iks`: IBM Kubernetes Service pipeline
- `Jenkinsfile.ext-icp`: IBM Cloud Private external registry

Pipelines use Maven, Docker, and kubectl containers in Jenkins pod templates.

## Liberty HTTP Endpoints

- Application Port: 9080 (HTTP)
- HTTPS Port: 9443
- Context Root: Configurable via `userName` property in pbw-ear/pom.xml (defaults to `/${userName}`)

## Legacy Considerations

- **Java Version**: Upgraded to Source 1.8, Target 1.8 (originally 1.6) for modern Java compatibility
- **Maven Plugins**: Updated to modern versions (maven-war-plugin 3.3.2, maven-compiler-plugin 3.8.0)
- **Database Flexibility**: Can switch between MySQL and MariaDB by uncommenting respective datasource blocks in server.xml
- **Liberty Base Image**: Uses `icr.io/appcafe/websphere-liberty:kernel-java8-openj9-ubi` (modern replacement for deprecated `websphere-liberty:kernel`)
